<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบเช็คการส่งงานนักเรียน</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
        body {
            box-sizing: border-box;
            font-family: 'Sarabun', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100%;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 2px solid #333;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #4a5568;
            margin: 0 0 15px 0;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header .subtitle {
            font-size: 1.2rem;
            color: #718096;
            margin: 5px 0;
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border: 2px solid #333;
            flex-wrap: wrap;
            gap: 10px;
        }

        .nav-tab {
            flex: 1;
            min-width: 200px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Sarabun', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            color: #4a5568;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .nav-tab:hover {
            background: linear-gradient(135deg, #e2e8f0, #cbd5e0);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .page {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 2px solid #333;
        }

        .page.active {
            display: block;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
            font-size: 1.1rem;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-family: 'Sarabun', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-family: 'Sarabun', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .student-list {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
        }

        .student-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            margin-bottom: 10px;
            background: #f7fafc;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }

        .student-info {
            font-weight: 500;
            color: #4a5568;
        }

        .status-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .status-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-option input[type="radio"] {
            margin: 0;
        }

        .status-option label {
            margin: 0;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #e2e8f0;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1rem;
            color: #718096;
            font-weight: 500;
        }

        .chart-container {
            background: #f7fafc;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e2e8f0;
            margin-top: 20px;
        }

        .welcome-content {
            text-align: center;
            padding: 40px 20px;
        }

        .welcome-icon {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 20px;
        }

        .welcome-text {
            font-size: 1.3rem;
            color: #718096;
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .feature-card {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #e2e8f0;
            transition: transform 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
        }

        .feature-icon {
            font-size: 2.5rem;
            color: #667eea;
            margin-bottom: 15px;
        }

        .feature-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .feature-desc {
            color: #718096;
            line-height: 1.5;
        }

        .connection-status {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .status-connected {
            color: #48bb78;
        }

        .status-disconnected {
            color: #f56565;
        }

        .status-checking {
            color: #ed8936;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #718096, #4a5568);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(113, 128, 150, 0.4);
        }

        .management-tabs {
            display: flex;
            background: #f7fafc;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 25px;
            border: 2px solid #e2e8f0;
        }

        .management-tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Sarabun', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            color: #718096;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .management-tab:hover {
            background: #e2e8f0;
        }

        .management-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .management-content {
            display: none;
        }

        .management-content.active {
            display: block;
        }

        .list-controls {
            display: flex;
            justify-content: space-between;
            align-items: end;
            margin-bottom: 20px;
            gap: 20px;
            flex-wrap: wrap;
        }

        .list-controls .form-group {
            margin-bottom: 0;
            flex: 1;
            min-width: 200px;
        }

        .student-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 2px solid #e2e8f0;
        }

        .student-table th,
        .student-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .student-table th {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            font-weight: 600;
            color: #4a5568;
        }

        .student-table tr:hover {
            background: #f7fafc;
        }

        .student-table .actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.9rem;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f56565, #e53e3e);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 101, 101, 0.4);
        }

        .loading-message {
            text-align: center;
            padding: 40px;
            color: #718096;
            font-size: 1.1rem;
        }

        .empty-message {
            text-align: center;
            padding: 40px;
            color: #718096;
            font-size: 1.1rem;
        }

        .empty-message i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #cbd5e0;
        }

        .connection-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 2px solid #333;
        }

        .connection-header h3 {
            margin: 0 0 20px 0;
            color: #4a5568;
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .connection-body {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .connection-status-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-indicator-main {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            font-size: 1.1rem;
        }

        .connection-details {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #718096;
            font-size: 0.95rem;
        }

        .detail-item i {
            width: 16px;
            text-align: center;
            color: #667eea;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .nav-tab {
                min-width: auto;
            }
            
            .student-item {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .status-group {
                width: 100%;
                justify-content: space-around;
            }

            .connection-status {
                flex-direction: column;
                text-align: center;
            }

            .list-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .student-table {
                font-size: 0.9rem;
            }

            .student-table th,
            .student-table td {
                padding: 10px 8px;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="container"><!-- Header -->
   <div class="header">
    <h1 id="system-title">ระบบเช็คการส่งงานนักเรียน</h1>
    <div class="subtitle" id="school-name">
     โรงเรียนสวรรค์อนันต์วิทยา
    </div>
    <div class="subtitle" id="subject-name">
     วิชา คณิตศาสตร์
    </div>
   </div><!-- Navigation -->
   <div class="nav-tabs"><button class="nav-tab active" onclick="showPage('dashboard')"> <i class="fas fa-home"></i> หน้าหลัก </button> <button class="nav-tab" onclick="showPage('checkin')"> <i class="fas fa-check-circle"></i> เช็คการส่งงาน </button> <button class="nav-tab" onclick="showPage('statistics')"> <i class="fas fa-chart-bar"></i> สถิติ </button> <button class="nav-tab" onclick="showPage('addstudent')"> <i class="fas fa-user-plus"></i> เพิ่มรายชื่อนักเรียน </button>
   </div><!-- Dashboard Page -->
   <div id="dashboard" class="page active"><!-- Connection Status Card -->
    <div class="connection-card">
     <div class="connection-header">
      <h3><i class="fas fa-wifi"></i> สถานะการเชื่อมต่อ Google Sheets</h3>
     </div>
     <div class="connection-body">
      <div class="connection-status-main">
       <div class="status-indicator-main"><i class="fas fa-circle" id="main-status-icon"></i> <span id="main-status-text">กำลังตรวจสอบการเชื่อมต่อ...</span>
       </div><button class="btn btn-secondary" onclick="checkConnection()"> <i class="fas fa-sync-alt"></i> ตรวจสอบใหม่ </button>
      </div>
      <div class="connection-details">
       <div class="detail-item"><i class="fas fa-database"></i> <span>Google Sheets ID: 1ueb4DWDzI2IyLkjN0Esy4ezKjwXYVnLXrTTbbramlo4</span>
       </div>
       <div class="detail-item"><i class="fas fa-clock"></i> <span id="last-check">ตรวจสอบล่าสุด: -</span>
       </div>
      </div>
     </div>
    </div>
    <div class="welcome-content">
     <div class="welcome-icon"><i class="fas fa-graduation-cap"></i>
     </div>
     <div class="welcome-text">
      ยินดีต้อนรับสู่ระบบเช็คการส่งงานนักเรียน<br>
       ระบบที่ช่วยให้การจัดการและติดตามการส่งงานของนักเรียนเป็นไปอย่างมีประสิทธิภาพ
     </div>
     <div class="feature-grid">
      <div class="feature-card">
       <div class="feature-icon"><i class="fas fa-check-circle"></i>
       </div>
       <div class="feature-title">
        เช็คการส่งงาน
       </div>
       <div class="feature-desc">
        บันทึกสถานะการส่งงานของนักเรียนแต่ละวัน
       </div>
      </div>
      <div class="feature-card">
       <div class="feature-icon"><i class="fas fa-chart-bar"></i>
       </div>
       <div class="feature-title">
        สถิติและรายงาน
       </div>
       <div class="feature-desc">
        ดูสถิติการส่งงานและสร้างรายงานสรุป
       </div>
      </div>
      <div class="feature-card">
       <div class="feature-icon"><i class="fas fa-user-plus"></i>
       </div>
       <div class="feature-title">
        จัดการนักเรียน
       </div>
       <div class="feature-desc">
        เพิ่มและจัดการข้อมูลนักเรียนในระบบ
       </div>
      </div>
     </div>
    </div>
   </div><!-- Check-in Page -->
   <div id="checkin" class="page">
    <h2><i class="fas fa-check-circle"></i> เช็คการส่งงาน</h2>
    <div class="form-group"><label for="checkin-date">วันที่:</label> <input type="date" id="checkin-date" class="form-control">
    </div>
    <div class="form-group"><label for="checkin-class">ชั้นเรียน:</label> <select id="checkin-class" class="form-control" onchange="loadStudents()"> <option value="">เลือกชั้นเรียน</option> <option value="ม.1/3">ม.1 ห้อง 1/3</option> <option value="ม.1/5">ม.1 ห้อง 1/5</option> <option value="ม.1/6">ม.1 ห้อง 1/6</option> </select>
    </div>
    <div id="student-list-container" style="display: none;">
     <h3>รายชื่อนักเรียน</h3>
     <div id="student-list" class="student-list"></div><button class="btn btn-primary" onclick="saveAttendance()"> <i class="fas fa-save"></i> บันทึกข้อมูล </button>
    </div>
   </div><!-- Statistics Page -->
   <div id="statistics" class="page">
    <h2><i class="fas fa-chart-bar"></i> สถิติการส่งงาน</h2>
    <div class="form-group"><label for="stats-class">ชั้นเรียน:</label> <select id="stats-class" class="form-control" onchange="loadStatistics()"> <option value="">เลือกชั้นเรียนเพื่อดูสถิติ</option> <option value="ม.1/3">ม.1 ห้อง 1/3</option> <option value="ม.1/5">ม.1 ห้อง 1/5</option> <option value="ม.1/6">ม.1 ห้อง 1/6</option> </select>
    </div>
    <div id="stats-content" style="display: none;">
     <div class="stats-grid">
      <div class="stat-card">
       <div class="stat-number" id="stat-submitted">
        0
       </div>
       <div class="stat-label"><i class="fas fa-check-circle" style="color: #48bb78;"></i> ส่งแล้ว
       </div>
      </div>
      <div class="stat-card">
       <div class="stat-number" id="stat-late">
        0
       </div>
       <div class="stat-label"><i class="fas fa-clock" style="color: #ed8936;"></i> ส่งช้า
       </div>
      </div>
      <div class="stat-card">
       <div class="stat-number" id="stat-missing">
        0
       </div>
       <div class="stat-label"><i class="fas fa-times-circle" style="color: #f56565;"></i> ขาดส่ง
       </div>
      </div>
     </div>
     <div class="chart-container">
      <canvas id="statsChart" width="400" height="200"></canvas>
     </div>
    </div>
   </div><!-- Add Student Page -->
   <div id="addstudent" class="page">
    <h2><i class="fas fa-user-plus"></i> จัดการรายชื่อนักเรียน</h2><!-- Student Management Tabs -->
    <div class="management-tabs"><button class="management-tab active" onclick="showManagementTab('add')"> <i class="fas fa-plus"></i> เพิ่มนักเรียน </button> <button class="management-tab" onclick="showManagementTab('list')"> <i class="fas fa-list"></i> รายชื่อนักเรียน </button>
    </div><!-- Add Student Tab -->
    <div id="add-tab" class="management-content active">
     <form id="add-student-form" onsubmit="addStudent(event)">
      <div class="form-group"><label for="student-id">เลขที่:</label> <input type="number" id="student-id" class="form-control" required min="1" max="50">
      </div>
      <div class="form-group"><label for="student-name">ชื่อ-สกุล:</label> <input type="text" id="student-name" class="form-control" required>
      </div>
      <div class="form-group"><label for="student-class">ชั้นเรียน:</label> <select id="student-class" class="form-control" required> <option value="">เลือกชั้นเรียน</option> <option value="ม.1/3">ม.1 ห้อง 1/3</option> <option value="ม.1/5">ม.1 ห้อง 1/5</option> <option value="ม.1/6">ม.1 ห้อง 1/6</option> </select>
      </div><button type="submit" class="btn btn-primary"> <i class="fas fa-plus"></i> เพิ่มนักเรียน </button>
     </form>
    </div><!-- Student List Tab -->
    <div id="list-tab" class="management-content">
     <div class="list-controls">
      <div class="form-group"><label for="filter-class">กรองตามชั้นเรียน:</label> <select id="filter-class" class="form-control" onchange="filterStudents()"> <option value="">ทุกชั้นเรียน</option> <option value="ม.1/3">ม.1 ห้อง 1/3</option> <option value="ม.1/5">ม.1 ห้อง 1/5</option> <option value="ม.1/6">ม.1 ห้อง 1/6</option> </select>
      </div><button class="btn btn-primary" onclick="refreshStudentList()"> <i class="fas fa-sync-alt"></i> รีเฟรชข้อมูล </button>
     </div>
     <div id="student-table-container">
      <div class="loading-message"><i class="fas fa-spinner fa-spin"></i> กำลังโหลดข้อมูลนักเรียน...
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
        // Configuration
        const defaultConfig = {
            system_title: "ระบบเช็คการส่งงานนักเรียน",
            school_name: "โรงเรียนสวรรค์อนันต์วิทยา",
            subject_name: "วิชา คณิตศาสตร์"
        };

        const SHEET_ID = '1ueb4DWDzI2IyLkjN0Esy4ezKjwXYVnLXrTTbbramlo4';
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwIq7zGplzjNClZ7_zn2hC7Tufh6rCvOKfTNPo2I1EBGURfRqaR4mezTD_VrO0lVJn-/exec';

        let students = [];
        let attendanceData = {};
        let filteredStudents = [];
        let connectionStatus = 'checking';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('checkin-date').value = today;
            
            // Load initial data and check connection
            checkConnection();
            loadStudentsData();
        });

        // Element SDK Implementation
        if (window.elementSdk) {
            window.elementSdk.init({
                defaultConfig: defaultConfig,
                onConfigChange: async (config) => {
                    document.getElementById('system-title').textContent = config.system_title || defaultConfig.system_title;
                    document.getElementById('school-name').textContent = config.school_name || defaultConfig.school_name;
                    document.getElementById('subject-name').textContent = config.subject_name || defaultConfig.subject_name;
                },
                mapToCapabilities: (config) => ({
                    recolorables: [],
                    borderables: [],
                    fontEditable: undefined,
                    fontSizeable: undefined
                }),
                mapToEditPanelValues: (config) => new Map([
                    ["system_title", config.system_title || defaultConfig.system_title],
                    ["school_name", config.school_name || defaultConfig.school_name],
                    ["subject_name", config.subject_name || defaultConfig.subject_name]
                ])
            });
        }

        // Navigation
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // JSONP helper function
        function makeJSONPRequest(url, data, callback) {
            const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
            
            window[callbackName] = function(response) {
                delete window[callbackName];
                document.body.removeChild(script);
                callback(response);
            };
            
            const script = document.createElement('script');
            const params = new URLSearchParams(data);
            params.append('callback', callbackName);
            script.src = url + '?' + params.toString();
            document.body.appendChild(script);
        }

        // Check connection status
        function checkConnection() {
            updateConnectionStatus('checking', 'กำลังตรวจสอบการเชื่อมต่อ...');
            
            makeJSONPRequest(SCRIPT_URL, { action: 'getStudents' }, function(response) {
                if (response && response.success !== undefined) {
                    updateConnectionStatus('connected', 'เชื่อมต่อสำเร็จ');
                    connectionStatus = 'connected';
                } else {
                    updateConnectionStatus('disconnected', 'ไม่สามารถเชื่อมต่อได้');
                    connectionStatus = 'disconnected';
                }
                updateLastCheckTime();
            });
            
            // Timeout after 10 seconds
            setTimeout(() => {
                if (connectionStatus === 'checking') {
                    updateConnectionStatus('disconnected', 'การเชื่อมต่อหมดเวลา');
                    connectionStatus = 'disconnected';
                    updateLastCheckTime();
                }
            }, 10000);
        }

        // Update connection status display
        function updateConnectionStatus(status, message) {
            // Update main dashboard status
            const mainStatusIcon = document.getElementById('main-status-icon');
            const mainStatusText = document.getElementById('main-status-text');
            
            if (mainStatusIcon && mainStatusText) {
                mainStatusIcon.classList.remove('status-connected', 'status-disconnected', 'status-checking');
                
                switch(status) {
                    case 'connected':
                        mainStatusIcon.classList.add('status-connected');
                        break;
                    case 'disconnected':
                        mainStatusIcon.classList.add('status-disconnected');
                        break;
                    case 'checking':
                        mainStatusIcon.classList.add('status-checking');
                        break;
                }
                
                mainStatusText.textContent = message;
            }
        }

        // Update last check time
        function updateLastCheckTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('th-TH', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            const lastCheckElement = document.getElementById('last-check');
            if (lastCheckElement) {
                lastCheckElement.textContent = `ตรวจสอบล่าสุด: ${timeString}`;
            }
        }

        // Load students data
        function loadStudentsData() {
            makeJSONPRequest(SCRIPT_URL, { action: 'getStudents' }, function(response) {
                if (response.success) {
                    students = response.data || [];
                    filteredStudents = [...students];
                    
                    // Update student list if on management page
                    if (document.getElementById('list-tab').classList.contains('active')) {
                        displayStudentList();
                    }
                }
            });
        }

        // Show management tab
        function showManagementTab(tabName) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.management-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.management-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Add active class to selected tab and content
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Load student list if switching to list tab
            if (tabName === 'list') {
                refreshStudentList();
            }
        }

        // Refresh student list
        function refreshStudentList() {
            document.getElementById('student-table-container').innerHTML = `
                <div class="loading-message">
                    <i class="fas fa-spinner fa-spin"></i>
                    กำลังโหลดข้อมูลนักเรียน...
                </div>
            `;
            
            loadStudentsData();
        }

        // Display student list
        function displayStudentList() {
            const container = document.getElementById('student-table-container');
            
            if (filteredStudents.length === 0) {
                container.innerHTML = `
                    <div class="empty-message">
                        <i class="fas fa-users"></i>
                        <div>ไม่มีข้อมูลนักเรียน</div>
                        <div style="font-size: 0.9rem; margin-top: 10px;">กรุณาเพิ่มนักเรียนในระบบก่อน</div>
                    </div>
                `;
                return;
            }
            
            const tableHtml = `
                <table class="student-table">
                    <thead>
                        <tr>
                            <th>เลขที่</th>
                            <th>ชื่อ-สกุล</th>
                            <th>ชั้นเรียน</th>
                            <th>การจัดการ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredStudents.map(student => `
                            <tr>
                                <td>${student.id}</td>
                                <td>${student.name}</td>
                                <td>${student.class}</td>
                                <td class="actions">
                                    <button class="btn btn-danger btn-small" onclick="deleteStudent(${student.id}, '${student.class}', '${student.name}')">
                                        <i class="fas fa-trash"></i>
                                        ลบ
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHtml;
        }

        // Filter students
        function filterStudents() {
            const filterClass = document.getElementById('filter-class').value;
            
            if (filterClass === '') {
                filteredStudents = [...students];
            } else {
                filteredStudents = students.filter(student => student.class === filterClass);
            }
            
            displayStudentList();
        }

        // Delete student
        function deleteStudent(studentId, studentClass, studentName) {
            Swal.fire({
                title: 'ยืนยันการลบ',
                text: `คุณต้องการลบ ${studentName} (เลขที่ ${studentId}) จากชั้น ${studentClass} หรือไม่?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#f56565',
                cancelButtonColor: '#718096',
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading
                    Swal.fire({
                        title: 'กำลังลบนักเรียน...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    makeJSONPRequest(SCRIPT_URL, {
                        action: 'deleteStudent',
                        data: JSON.stringify({ id: studentId, class: studentClass })
                    }, function(response) {
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'ลบสำเร็จ!',
                                text: `ลบ ${studentName} ออกจากระบบแล้ว`
                            });
                            
                            // Remove from local array
                            students = students.filter(s => !(s.id == studentId && s.class === studentClass));
                            filterStudents();
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: response.message || 'ไม่สามารถลบนักเรียนได้'
                            });
                        }
                    });
                }
            });
        }

        // Load students for selected class
        function loadStudents() {
            const selectedClass = document.getElementById('checkin-class').value;
            if (!selectedClass) {
                document.getElementById('student-list-container').style.display = 'none';
                return;
            }

            const classStudents = students.filter(student => student.class === selectedClass);
            const studentListHtml = classStudents.map(student => `
                <div class="student-item">
                    <div class="student-info">
                        ${student.id}. ${student.name}
                    </div>
                    <div class="status-group">
                        <div class="status-option">
                            <input type="radio" id="submitted_${student.id}" name="status_${student.id}" value="ส่งแล้ว">
                            <label for="submitted_${student.id}">
                                <i class="fas fa-check-circle" style="color: #48bb78;"></i>
                                ส่งแล้ว
                            </label>
                        </div>
                        <div class="status-option">
                            <input type="radio" id="late_${student.id}" name="status_${student.id}" value="ส่งช้า">
                            <label for="late_${student.id}">
                                <i class="fas fa-clock" style="color: #ed8936;"></i>
                                ส่งช้า
                            </label>
                        </div>
                        <div class="status-option">
                            <input type="radio" id="missing_${student.id}" name="status_${student.id}" value="ขาดส่ง">
                            <label for="missing_${student.id}">
                                <i class="fas fa-times-circle" style="color: #f56565;"></i>
                                ขาดส่ง
                            </label>
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('student-list').innerHTML = studentListHtml;
            document.getElementById('student-list-container').style.display = 'block';
        }

        // Save attendance
        function saveAttendance() {
            const date = document.getElementById('checkin-date').value;
            const selectedClass = document.getElementById('checkin-class').value;
            
            if (!date || !selectedClass) {
                Swal.fire({
                    icon: 'warning',
                    title: 'ข้อมูลไม่ครบถ้วน',
                    text: 'กรุณาเลือกวันที่และชั้นเรียน'
                });
                return;
            }

            const classStudents = students.filter(student => student.class === selectedClass);
            const attendanceRecords = [];

            classStudents.forEach(student => {
                const statusRadio = document.querySelector(`input[name="status_${student.id}"]:checked`);
                if (statusRadio) {
                    attendanceRecords.push({
                        date: date,
                        student_id: student.id,
                        student_name: student.name,
                        class: selectedClass,
                        status: statusRadio.value
                    });
                }
            });

            if (attendanceRecords.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'ไม่มีข้อมูลที่จะบันทึก',
                    text: 'กรุณาเลือกสถานะสำหรับนักเรียนอย่างน้อย 1 คน'
                });
                return;
            }

            // Show loading
            Swal.fire({
                title: 'กำลังบันทึกข้อมูล...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            makeJSONPRequest(SCRIPT_URL, {
                action: 'saveAttendance',
                data: JSON.stringify(attendanceRecords)
            }, function(response) {
                if (response.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'บันทึกสำเร็จ!',
                        text: `บันทึกข้อมูลการส่งงานเรียบร้อยแล้ว (${attendanceRecords.length} รายการ)`
                    });
                    
                    // Clear form
                    document.querySelectorAll('input[type="radio"]').forEach(radio => {
                        radio.checked = false;
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: response.message || 'ไม่สามารถบันทึกข้อมูลได้'
                    });
                }
            });
        }

        // Add student
        function addStudent(event) {
            event.preventDefault();
            
            const studentId = document.getElementById('student-id').value;
            const studentName = document.getElementById('student-name').value;
            const studentClass = document.getElementById('student-class').value;

            // Check for duplicate ID in same class
            const existingStudent = students.find(s => s.id == studentId && s.class === studentClass);
            if (existingStudent) {
                Swal.fire({
                    icon: 'warning',
                    title: 'เลขที่ซ้ำ',
                    text: `เลขที่ ${studentId} มีอยู่แล้วในชั้น ${studentClass}`
                });
                return;
            }

            // Show loading
            Swal.fire({
                title: 'กำลังเพิ่มนักเรียน...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const studentData = {
                id: parseInt(studentId),
                name: studentName,
                class: studentClass
            };

            makeJSONPRequest(SCRIPT_URL, {
                action: 'addStudent',
                data: JSON.stringify(studentData)
            }, function(response) {
                if (response.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'เพิ่มนักเรียนเรียบร้อย!',
                        text: `เพิ่ม ${studentName} เข้าสู่ระบบแล้ว`
                    });
                    
                    // Add to local array
                    students.push(studentData);
                    
                    // Clear form
                    document.getElementById('add-student-form').reset();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: response.message || 'ไม่สามารถเพิ่มนักเรียนได้'
                    });
                }
            });
        }

        // Load statistics
        function loadStatistics() {
            const selectedClass = document.getElementById('stats-class').value;
            if (!selectedClass) {
                document.getElementById('stats-content').style.display = 'none';
                return;
            }

            makeJSONPRequest(SCRIPT_URL, {
                action: 'getStatistics',
                class: selectedClass
            }, function(response) {
                if (response.success) {
                    const stats = response.data;
                    
                    document.getElementById('stat-submitted').textContent = stats.submitted || 0;
                    document.getElementById('stat-late').textContent = stats.late || 0;
                    document.getElementById('stat-missing').textContent = stats.missing || 0;
                    
                    // Update chart
                    updateChart(stats);
                    
                    document.getElementById('stats-content').style.display = 'block';
                }
            });
        }

        // Update chart
        let statsChart = null;
        function updateChart(stats) {
            const ctx = document.getElementById('statsChart').getContext('2d');
            
            if (statsChart) {
                statsChart.destroy();
            }
            
            statsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ส่งแล้ว', 'ส่งช้า', 'ขาดส่ง'],
                    datasets: [{
                        data: [stats.submitted || 0, stats.late || 0, stats.missing || 0],
                        backgroundColor: ['#48bb78', '#ed8936', '#f56565'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    family: 'Sarabun',
                                    size: 14
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9968f645d5442dc0',t:'MTc2MTgwNjg1NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>